<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Module Selector</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">

<h1 class="mb-4">Module Selection</h1>

<!-- User Info -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Welcome</h5>
        <!-- Show more info about the user -->
        <p class="card-text">
            <strong>Name:</strong> <span th:text="${userData.name}"></span><br/>
            <strong>Surname:</strong> <span th:text="${userData.surname}"></span><br/>
            <strong>Birth Date:</strong> <span th:text="${userData.birthDate}"></span><br/>
            <strong>Matriculation:</strong> <span th:text="${userData.matriculation}"></span><br/>
            <strong>Country:</strong> <span th:text="${userData.country}"></span><br/>
            <strong>Email:</strong> <span th:text="${userData.email}"></span><br/>
        </p>
        <!-- Link to edit the data -->
        <a class="btn btn-secondary" th:href="@{/survey}">Edit Personal Data</a>
    </div>
</div>

<!-- Subject Selection -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Choose Your Subject</h5>
        <form th:action="@{/subject}" method="post" id="subjectForm">
            <select class="form-select mb-3" name="subject" onchange="this.form.submit()">
                <option th:each="subject : ${T(org.rr.moduleselector.selector.model.Subject).values()}"
                        th:value="${subject}"
                        th:text="${subject.displayName}"
                        th:selected="${session.selectedSubject == subject}">
                </option>
            </select>
        </form>
    </div>
</div>

<!-- Modules Section (only shown if subject is selected) -->
<div th:if="${session.selectedSubject != null}">
    <!-- Iterate semesters 1-2 and 4 as "normal" -->
    <div th:each="semester : ${#numbers.sequence(1,2)}" class="card mb-4">
        <div class="card-header">
            <h5 th:text="'Semester ' + ${semester}"></h5>
        </div>
        <div class="card-body">
            <form th:action="@{'/semester/' + ${semester} + '/save'}" method="post">
                <!-- Compulsory Modules -->
                <h6>Compulsory Modules:</h6>
                <ul class="list-group mb-3">
                    <li th:each="module : ${__${'compulsoryModules' + semester}__}"
                        class="list-group-item"
                        th:text="${module.fullName}">
                    </li>
                </ul>

                <!-- Additional Modules (as bullet points, plus radio if alternatives) -->
                <div th:if="${!__${'additionalModules' + semester}__.empty}">
                    <h6>Additional Modules:</h6>
                    <ul class="list-group mb-3">
                        <li th:each="module : ${__${'additionalModules' + semester}__}"
                            class="list-group-item">
                            <!-- If this module has no alternatives, just show bullet -->
                            <span th:text="${module.fullName}"
                                  th:if="${module.alternative.empty}"></span>

                            <!-- If there are alternatives, show them as radio group -->
                            <div th:if="${!module.alternative.empty}">
                                <strong th:text="${module.fullName}"> </strong>
                                <div class="ms-4" th:each="alt : ${module.alternative}">
                                    <div class="form-check">
                                        <input type="radio"
                                               class="form-check-input"
                                               th:name="${'alt' + module.code}"
                                               th:id="${'alt' + alt.code}"
                                               th:value="${alt.code}"
                                               th:checked="${__${'session.semester' + semester + 'Alternatives'}__?.get(module.code) == alt.code}">
                                        <label class="form-check-label" th:for="${'alt' + alt.code}"
                                               th:text="${alt.fullName}"></label>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>

                <button type="submit" class="btn btn-primary"
                        th:text="'Save Semester ' + ${semester} + ' Selection'">
                </button>
            </form>
        </div>
    </div>

    <!-- SPECIAL CASE: Semester 3 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Semester 3</h5>
        </div>
        <div class="card-body">
            <form th:action="@{'/semester/3/save'}" method="post">
                <!-- Compulsory Modules -->
                <h6>Compulsory Modules:</h6>
                <ul class="list-group mb-3">
                    <li th:each="module : ${compulsoryModules3}"
                        class="list-group-item"
                        th:text="${module.fullName}">
                    </li>
                </ul>

                <!-- Choose partner university -->
                <h6>Choose Partner University (Study Abroad):</h6>
                <select class="form-select mb-3"
                        name="selectedPartnerUniversity"
                        onchange="this.form.submit()">
                    <option value="">-- No Selection --</option>
                    <option th:each="uni : ${universities}"
                            th:value="${uni}"
                            th:text="${uni.displayName + ' (' + uni.country + ')'}"
                            th:selected="${session.selectedPartnerUniversity == uni}">
                    </option>
                </select>

                <!-- Show modules only if a partner is chosen -->
                <div th:if="${session.selectedPartnerUniversity != null}">
                    <h6 th:text="'Modules at ' + ${session.selectedPartnerUniversity.displayName}"></h6>
                    <ul class="list-group mb-3">
                        <li th:each="module : ${studyAbroadModules}"
                            class="list-group-item">
                            <!-- If there are no alternatives, just show bullet -->
                            <span th:text="${module.fullName}"
                                  th:if="${module.alternative.empty}"></span>

                            <!-- If there are alternatives, show radio selection -->
                            <div th:if="${!module.alternative.empty}">
                                <strong th:text="${module.fullName}"> </strong>
                                <div class="ms-4" th:each="alt : ${module.alternative}">
                                    <div class="form-check">
                                        <input type="radio"
                                               class="form-check-input"
                                               th:name="${'alt' + module.code}"
                                               th:id="${'alt' + alt.code}"
                                               th:value="${alt.code}"
                                               th:checked="${__${'session.semester3Alternatives'}__?.get(module.code) == alt.code}">
                                        <label class="form-check-label"
                                               th:for="${'alt' + alt.code}"
                                               th:text="${alt.fullName}"></label>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>

                <button type="submit" class="btn btn-primary">
                    Save Semester 3 Selection
                </button>
            </form>
        </div>
    </div>

    <!-- Semester 4 (same approach as semesters 1-2) -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Semester 4</h5>
        </div>
        <div class="card-body">
            <form th:action="@{'/semester/4/save'}" method="post">
                <!-- Compulsory Modules -->
                <h6>Compulsory Modules:</h6>
                <ul class="list-group mb-3">
                    <li th:each="module : ${compulsoryModules4}"
                        class="list-group-item"
                        th:text="${module.fullName}">
                    </li>
                </ul>

                <!-- Additional Modules, if any (bullet points + radio if alternatives) -->
                <div th:if="${!additionalModules4.empty}">
                    <h6>Additional Modules:</h6>
                    <ul class="list-group mb-3">
                        <li th:each="module : ${additionalModules4}"
                            class="list-group-item">
                            <span th:text="${module.fullName}"
                                  th:if="${module.alternative.empty}"></span>
                            <div th:if="${!module.alternative.empty}">
                                <strong th:text="${module.fullName}"></strong>
                                <div class="ms-4" th:each="alt : ${module.alternative}">
                                    <div class="form-check">
                                        <input type="radio"
                                               class="form-check-input"
                                               th:name="${'alt' + module.code}"
                                               th:id="${'alt' + alt.code}"
                                               th:value="${alt.code}"
                                               th:checked="${__${'session.semester4Alternatives'}__?.get(module.code) == alt.code}">
                                        <label class="form-check-label" th:for="${'alt' + alt.code}"
                                               th:text="${alt.fullName}"></label>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>

                <button type="submit" class="btn btn-primary">
                    Save Semester 4 Selection
                </button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
